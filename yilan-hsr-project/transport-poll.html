<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®œè˜­äº¤é€šè¡Œç‚ºå¤§èª¿æŸ¥</title>
    <style>
        :root {
            --primary: #2c3e50;
            --highlight: #e63946; /* å®œè˜­ç´… */
            --bg: #f8f9fa;
            --bar-bg: #e9ecef;
        }

        body {
            font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
            background: var(--bg);
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .poll-container {
            max-width: 800px;
            width: 100%;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        h2 { text-align: center; color: var(--primary); margin-bottom: 10px; }
        p.intro { text-align: center; color: #666; margin-bottom: 40px; }

        /* å€å¡Šæ¨£å¼ */
        .poll-section {
            margin-bottom: 50px;
            padding-bottom: 30px;
            border-bottom: 1px dashed #ddd;
        }
        .poll-section:last-child { border-bottom: none; }

        .question-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .badge {
            background: var(--primary);
            color: white;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 0.8em;
        }
        .badge.future { background: var(--highlight); }

        /* æŒ‰éˆ•å€åŸŸ */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .option-btn {
            padding: 15px;
            border: 2px solid #eee;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1em;
            color: #444;
        }

        .option-btn:hover {
            border-color: #aaa;
            background: #fdfdfd;
            transform: translateY(-2px);
        }

        .icon { font-size: 1.5em; }

        /* çµæœå€åŸŸ */
        .results-area {
            display: none;
            margin-top: 20px;
        }

        .result-item { margin-bottom: 15px; }
        
        .result-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #555;
        }

        .progress-bar-bg {
            width: 100%;
            height: 12px;
            background: var(--bar-bg);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            border-radius: 10px;
            transition: width 1s ease-out;
        }

        .progress-bar-fill.hsr-fill { background: var(--highlight); }

        .total-votes {
            text-align: right;
            font-size: 0.8em;
            color: #999;
            margin-top: 10px;
        }

        @media (max-width: 600px) {
            .options-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="poll-container">
    <h2>å®œè˜­äº¤é€šå¤§èª¿æŸ¥</h2>
    <p class="intro">ä½ çš„é¸æ“‡ï¼Œæ±ºå®šäº†é«˜éµæ˜¯çœŸçš„æœ‰ç”¨ï¼Œé‚„æ˜¯èšŠå­å»ºè¨­ã€‚</p>

    <div class="poll-section" id="poll-now">
        <div class="question-title">
            <span class="badge">ç¾åœ¨</span> Q1ï¼šä½ ç›®å‰å»å®œè˜­ï¼Œæœ€å¸¸ä½¿ç”¨ä»€éº¼äº¤é€šå·¥å…·ï¼Ÿ
        </div>

        <div class="options-grid" id="options-now">
            <button class="option-btn" onclick="vote('now', 'car')">
                <span class="icon">ğŸš—</span> é–‹è»Š (åœ‹é“äº”è™Ÿ)
            </button>
            <button class="option-btn" onclick="vote('now', 'bus')">
                <span class="icon">ğŸšŒ</span> å®¢é‹ (è‘›ç‘ªè˜­/é¦–éƒ½)
            </button>
            <button class="option-btn" onclick="vote('now', 'train')">
                <span class="icon">ğŸš†</span> å°éµ (æ™®æ‚ ç‘ª/å€é–“)
            </button>
            <button class="option-btn" onclick="vote('now', 'other')">
                <span class="icon">ğŸ›µ</span> å…¶ä»– (æ©Ÿè»Š/å…±ä¹˜)
            </button>
        </div>

        <div class="results-area" id="results-now"></div>
    </div>

    <div class="poll-section" id="poll-future">
        <div class="question-title">
            <span class="badge future">10å¹´å¾Œ</span> Q2ï¼šé«˜éµé€šè»Šå¾Œï¼Œä½ ã€ŒçœŸçš„ã€æœƒæ”¹æ­é«˜éµå—ï¼Ÿ
        </div>

        <div class="options-grid" id="options-future">
            <button class="option-btn" onclick="vote('future', 'hsr')">
                <span class="icon">ğŸš„</span> æœƒï¼æ”¹æ­é«˜éµ (å–®ç¨‹ç´„300å…ƒ)
            </button>
            <button class="option-btn" onclick="vote('future', 'car')">
                <span class="icon">ğŸš—</span> ä¸æœƒï¼Œç¹¼çºŒé–‹è»Š (æ¯”è¼ƒæ–¹ä¾¿)
            </button>
            <button class="option-btn" onclick="vote('future', 'train')">
                <span class="icon">ğŸš†</span> ä¸æœƒï¼Œç¹¼çºŒæ­å°éµ (æ¯”è¼ƒä¾¿å®œ)
            </button>
            <button class="option-btn" onclick="vote('future', 'bus')">
                <span class="icon">ğŸšŒ</span> ä¸æœƒï¼Œç¹¼çºŒæ­å®¢é‹ (é»å°é»æ–¹ä¾¿)
            </button>
        </div>

        <div class="results-area" id="results-future"></div>
    </div>

</div>

<script>
    // ğŸ”¥ğŸ”¥ğŸ”¥ è«‹å‹™å¿…ç¢ºèªé€™è£¡æ˜¯ä½ æœ€æ–°çš„ Google Apps Script ç¶²å€ ğŸ”¥ğŸ”¥ğŸ”¥
    const API_URL = "https://script.google.com/macros/s/AKfycbzW4VJoYoOuTctVKftN2mCm66h1OJq4V3Ej9VHChf82Qdfa6gKX-2zqI6FJEKpKZVyp/exec"; 

    // æª¢æŸ¥æœ¬åœ°æ˜¯å¦æŠ•é
    let userVoted = JSON.parse(localStorage.getItem('yilan_user_voted')) || { now: false, future: false };
    let currentData = {}; 

    // é é¢è¼‰å…¥æ™‚ï¼Œå…ˆå»é›²ç«¯æŠ“å–æœ€æ–°ç¥¨æ•¸
    document.addEventListener('DOMContentLoaded', () => {
        fetchVotes();
        if (userVoted.now) showResultsUI('now');
        if (userVoted.future) showResultsUI('future');
    });

    // 1. å¾ Google Sheet æŠ“å–è³‡æ–™ (GET)
    function fetchVotes() {
        const url = API_URL + "?action=get&t=" + new Date().getTime();
        
        fetch(url, { method: "GET" })
            .then(response => response.json())
            .then(data => {
                if(data.status === "error") {
                    console.error("å¾Œç«¯å›å‚³éŒ¯èª¤:", data.message);
                    return;
                }
                console.log("æ•¸æ“šæ›´æ–°æˆåŠŸ", data);
                
                // è½‰æ ¼å¼
                currentData = formatData(data);
                
                // æ›´æ–°åœ–è¡¨
                if (userVoted.now) updateCharts('now');
                if (userVoted.future) updateCharts('future');
            })
            .catch(error => console.error('é€£ç·šéŒ¯èª¤:', error));
    }

    // 2. æŠ•ç¥¨å‹•ä½œ (GET)
    function vote(type, choice) {
        const voteId = type + "_" + choice;
        const btnArea = document.getElementById(`options-${type}`);
        
        // æš«æ™‚é–å®šæŒ‰éˆ•é¿å…é€£é»
        btnArea.style.opacity = '0.5';
        btnArea.style.pointerEvents = 'none';

        const url = API_URL + "?action=vote&id=" + voteId + "&t=" + new Date().getTime();

        fetch(url, { method: "GET" })
            .then(response => response.json())
            .then(data => {
                if(data.status === "error") {
                    alert("ç³»çµ±éŒ¯èª¤: " + data.message);
                    btnArea.style.opacity = '1';
                    btnArea.style.pointerEvents = 'auto';
                    return;
                }
                
                // æ›´æ–°æ•¸æ“šèˆ‡ç‹€æ…‹
                currentData = formatData(data);
                userVoted[type] = true;
                localStorage.setItem('yilan_user_voted', JSON.stringify(userVoted));
                
                // é¡¯ç¤ºçµæœ
                showResultsUI(type);
                updateCharts(type);
            })
            .catch(error => {
                alert("æŠ•ç¥¨é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ï¼");
                console.error(error);
                btnArea.style.opacity = '1';
                btnArea.style.pointerEvents = 'auto';
            });
    }

    // 3. è³‡æ–™æ ¼å¼è½‰æ›å‡½å¼ (é‡è¦ï¼)
    function formatData(flatData) {
        return {
            now: {
                car: flatData['now_car'] || 0,
                bus: flatData['now_bus'] || 0,
                train: flatData['now_train'] || 0,
                other: flatData['now_other'] || 0
            },
            future: {
                hsr: flatData['future_hsr'] || 0,
                car: flatData['future_car'] || 0,
                train: flatData['future_train'] || 0,
                bus: flatData['future_bus'] || 0
            }
        };
    }

    // 4. ä»‹é¢åˆ‡æ›
    function showResultsUI(type) {
        document.getElementById(`options-${type}`).style.display = 'none';
        document.getElementById(`results-${type}`).style.display = 'block';
    }

    // 5. ç¹ªè£½åœ–è¡¨
    function updateCharts(type) {
        if (!currentData[type]) return;

        const resultDiv = document.getElementById(`results-${type}`);
        const total = Object.values(currentData[type]).reduce((a, b) => a + b, 0);
        
        const labels = {
            now: { car: "é–‹è»Š", bus: "å®¢é‹", train: "å°éµ", other: "å…¶ä»–" },
            future: { hsr: "æ”¹æ­é«˜éµ", car: "ç¹¼çºŒé–‹è»Š", train: "ç¹¼çºŒå°éµ", bus: "ç¹¼çºŒå®¢é‹" }
        };

        const sortedKeys = Object.keys(currentData[type]).sort((a,b) => currentData[type][b] - currentData[type][a]);
        
        let html = '';
        sortedKeys.forEach(key => {
            const count = currentData[type][key];
            const percent = total === 0 ? 0 : Math.round((count / total) * 100);
            const specialClass = (key === 'hsr') ? 'hsr-fill' : '';
            const icon = getIcon(key);

            html += `
                <div class="result-item">
                    <div class="result-label">
                        <span>${icon} ${labels[type][key]}</span>
                        <span>${percent}% (${count}ç¥¨)</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill ${specialClass}" style="width: ${percent}%"></div>
                    </div>
                </div>
            `;
        });

        html += `<div class="total-votes">ç´¯ç©åƒèˆ‡äººæ•¸ï¼š${total} äºº</div>`;
        
        if(type === 'future' && total > 0) {
             html += `<p style="text-align:center; font-size:0.9em; color:#e63946; margin-top:15px; font-weight:bold;">
                ç™¼ç¾äº†å—ï¼Ÿå³ä½¿é«˜éµè“‹å¥½ï¼Œé¸æ“‡ã€Œç¹¼çºŒé–‹è»Šã€çš„äººä¾ç„¶ä½”å¤šæ•¸ã€‚<br>åœ‹äº”å¡è»Šå•é¡Œï¼ŒçœŸçš„èƒ½è§£æ±ºå—ï¼Ÿ
             </p>`;
        }

        resultDiv.innerHTML = html;
    }

    function getIcon(key) {
        if(key === 'car') return 'ğŸš—';
        if(key === 'bus') return 'ğŸšŒ';
        if(key === 'train') return 'ğŸš†';
        if(key === 'hsr') return 'ğŸš„';
        return 'ğŸ›µ';
    }
</script>

</body>
</html>